<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- <title>Docker를 활용한 deep learning 개발 환경 구축</title> -->
    <title>EXPERIENTIA DOCET| Docker를 활용한 deep learning 개발 환경 구축</title>
    <meta name="description" content="hanjack
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://localhost:4000/docker/2017/12/01/nvidia-docker-ngc.html">

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <line rel="stylesheet" href="/css/solarized_light.css"

    <!-- mathjax config similar to math.stackexchange -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$']],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      messageStyle: "none",
      "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
    });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
</head>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111671880-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111671880-1');
</script>


  <body>
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1">
  <defs>
    <symbol id="icon-menu" viewBox="0 0 1024 1024">
      <path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/>
    </symbol>
    <symbol id="icon-search" viewBox="0 0 951 1024">
      <path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/>
    </symbol>
    <symbol id="icon-email" viewBox="0 0 1024 1024">
      <path class="path1" d="M950.857 859.429v-438.857q-18.286 20.571-39.429 37.714-153.143 117.714-243.429 193.143-29.143 24.571-47.429 38.286t-49.429 27.714-58.571 14h-1.143q-27.429 0-58.571-14t-49.429-27.714-47.429-38.286q-90.286-75.429-243.429-193.143-21.143-17.143-39.429-37.714v438.857q0 7.429 5.429 12.857t12.857 5.429h841.143q7.429 0 12.857-5.429t5.429-12.857zM950.857 258.857v-14t-0.286-7.429-1.714-7.143-3.143-5.143-5.143-4.286-8-1.429h-841.143q-7.429 0-12.857 5.429t-5.429 12.857q0 96 84 162.286 110.286 86.857 229.143 181.143 3.429 2.857 20 16.857t26.286 21.429 25.429 18 28.857 15.714 24.571 5.143h1.143q11.429 0 24.571-5.143t28.857-15.714 25.429-18 26.286-21.429 20-16.857q118.857-94.286 229.143-181.143 30.857-24.571 57.429-66t26.571-75.143zM1024 237.714v621.714q0 37.714-26.857 64.571t-64.571 26.857h-841.143q-37.714 0-64.571-26.857t-26.857-64.571v-621.714q0-37.714 26.857-64.571t64.571-26.857h841.143q37.714 0 64.571 26.857t26.857 64.571z"/>
    </symbol>
    <symbol id="icon-close" viewBox="0 0 805 1024">
      <path class="path1" d="M741.714 755.429q0 22.857-16 38.857l-77.714 77.714q-16 16-38.857 16t-38.857-16l-168-168-168 168q-16 16-38.857 16t-38.857-16l-77.714-77.714q-16-16-16-38.857t16-38.857l168-168-168-168q-16-16-16-38.857t16-38.857l77.714-77.714q16-16 38.857-16t38.857 16l168 168 168-168q16-16 38.857-16t38.857 16l77.714 77.714q16 16 16 38.857t-16 38.857l-168 168 168 168q16 16 16 38.857z"/>
    </symbol>
    <symbol id="icon-twitter" viewBox="0 0 951 1024">
      <path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/>
    </symbol>
    <symbol id="icon-facebook" viewBox="0 0 585 1024">
      <path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/>
    </symbol>
    <symbol id="icon-rss" viewBox="0 0 805 1024">
      <path class="path1" d="M219.429 768q0 45.714-32 77.714t-77.714 32-77.714-32-32-77.714 32-77.714 77.714-32 77.714 32 32 77.714zM512 838.286q1.143 16-9.714 27.429-10.286 12-26.857 12h-77.143q-14.286 0-24.571-9.429t-11.429-23.714q-12.571-130.857-105.429-223.714t-223.714-105.429q-14.286-1.143-23.714-11.429t-9.429-24.571v-77.143q0-16.571 12-26.857 9.714-9.714 24.571-9.714h2.857q91.429 7.429 174.857 46t148 103.714q65.143 64.571 103.714 148t46 174.857zM804.571 839.429q1.143 15.429-10.286 26.857-10.286 11.429-26.286 11.429h-81.714q-14.857 0-25.429-10t-11.143-24.286q-6.857-122.857-57.714-233.429t-132.286-192-192-132.286-233.429-58.286q-14.286-0.571-24.286-11.143t-10-24.857v-81.714q0-16 11.429-26.286 10.286-10.286 25.143-10.286h1.714q149.714 7.429 286.571 68.571t243.143 168q106.857 106.286 168 243.143t68.571 286.571z"/>
    </symbol>
    <symbol id="icon-google-plus" viewBox="0 0 951 1024">
      <path class="path1" d="M420 454.857q0 20.571 18.286 40.286t44.286 38.857 51.714 42 44 59.429 18.286 81.143q0 51.429-27.429 98.857-41.143 69.714-120.571 102.571t-170.286 32.857q-75.429 0-140.857-23.714t-98-78.571q-21.143-34.286-21.143-74.857 0-46.286 25.429-85.714t67.714-65.714q74.857-46.857 230.857-57.143-18.286-24-27.143-42.286t-8.857-41.714q0-20.571 12-48.571-26.286 2.286-38.857 2.286-84.571 0-142.571-55.143t-58-139.714q0-46.857 20.571-90.857t56.571-74.857q44-37.714 104.286-56t124.286-18.286h238.857l-78.857 50.286h-74.857q42.286 36 64 76t21.714 91.429q0 41.143-14 74t-33.714 53.143-39.714 37.143-34 35.143-14 37.714zM336.571 400q21.714 0 44.571-9.429t37.714-24.857q30.286-32.571 30.286-90.857 0-33.143-9.714-71.429t-27.714-74-48.286-59.143-66.857-23.429q-24 0-47.143 11.143t-37.429 30q-26.857 33.714-26.857 91.429 0 26.286 5.714 55.714t18 58.857 29.714 52.857 42.857 38.286 55.143 14.857zM337.714 898.857q33.143 0 63.714-7.429t56.571-22.286 41.714-41.714 15.714-62.286q0-14.286-4-28t-8.286-24-15.429-23.714-16.857-20-22-19.714-20.857-16.571-23.714-17.143-20.857-14.857q-9.143-1.143-27.429-1.143-30.286 0-60 4t-61.429 14.286-55.429 26.286-39.143 42.571-15.429 60.286q0 40 20 70.571t52.286 47.429 68 25.143 72.857 8.286zM800.571 398.286h121.714v61.714h-121.714v125.143h-60v-125.143h-121.143v-61.714h121.143v-124h60v124z"/>
    </symbol>
    <symbol id="icon-angle-down" viewBox="0 0 658 1024">
      <path class="path1" d="M614.286 420.571q0 7.429-5.714 13.143l-266.286 266.286q-5.714 5.714-13.143 5.714t-13.143-5.714l-266.286-266.286q-5.714-5.714-5.714-13.143t5.714-13.143l28.571-28.571q5.714-5.714 13.143-5.714t13.143 5.714l224.571 224.571 224.571-224.571q5.714-5.714 13.143-5.714t13.143 5.714l28.571 28.571q5.714 5.714 5.714 13.143z"/>
    </symbol>
    <symbol id="icon-github-alt" viewBox="0 0 951 1024">
      <path class="path1" d="M365.714 694.857q0 22.857-7.143 46.857t-24.571 43.429-41.429 19.429-41.429-19.429-24.571-43.429-7.143-46.857 7.143-46.857 24.571-43.429 41.429-19.429 41.429 19.429 24.571 43.429 7.143 46.857zM731.429 694.857q0 22.857-7.143 46.857t-24.571 43.429-41.429 19.429-41.429-19.429-24.571-43.429-7.143-46.857 7.143-46.857 24.571-43.429 41.429-19.429 41.429 19.429 24.571 43.429 7.143 46.857zM822.857 694.857q0-68.571-39.429-116.571t-106.857-48q-23.429 0-111.429 12-40.571 6.286-89.714 6.286t-89.714-6.286q-86.857-12-111.429-12-67.429 0-106.857 48t-39.429 116.571q0 50.286 18.286 87.714t46.286 58.857 69.714 34.286 80 16.857 85.143 4h96q46.857 0 85.143-4t80-16.857 69.714-34.286 46.286-58.857 18.286-87.714zM950.857 594.286q0 118.286-34.857 189.143-21.714 44-60.286 76t-80.571 49.143-97.143 27.143-98 12.571-95.429 2.571q-44.571 0-81.143-1.714t-84.286-7.143-87.143-17.143-78.286-29.429-69.143-46.286-49.143-65.714q-35.429-70.286-35.429-189.143 0-135.429 77.714-226.286-15.429-46.857-15.429-97.143 0-66.286 29.143-124.571 61.714 0 108.571 22.571t108 70.571q84-20 176.571-20 84.571 0 160 18.286 60-46.857 106.857-69.143t108-22.286q29.143 58.286 29.143 124.571 0 49.714-15.429 96 77.714 91.429 77.714 227.429z"/></symbol><symbol id="icon-linkedin" viewBox="0 0 1792 1792"><path class="path1" d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/>
    </symbol>
  </defs>
</svg>

    <header class="site-header">

  <div class="wrapper">
    <div class="site-title" ><a href="/about/">EXPERIENTIA DOCET</a></div>
    <div class="site-description">hanjack
</div>

    <nav class="site-nav">

      <div class="trigger">
        <!-- EXPERIENTIA DOCET instead of blog -->
        <a class="page-link" href="/">Home</a>

        

          
        

          
          |<a class="page-link" href="/archive.html">Archive</a>&nbsp;
          
        

          
          |<a class="page-link" href="/categories.html">Categories</a>&nbsp;
          
        

          
        

          
        

          
        

          
          |<a class="page-link" href="/tags.html">Tags</a>&nbsp;
          
        

      </div>
    </nav>
  </div>

</header>



    <div class="page-content">
      <div class="post-content">
        <div class="post">
  <header class="post-header">
    <div class="post-title"><p>Docker를 활용한 deep learning 개발 환경 구축</p></div>
    <p class="post-meta">December 1, 2017</p>
    <p class="post-meta"><div class="post-tags">
  <i class="fa fa-tags"></i>
  
  
  <a href="/tags/#docker" class="tag-item">docker</a>,
  
  <a href="/tags/#nvidia-docker" class="tag-item">nvidia-docker</a>,
  
  <a href="/tags/#NGC" class="tag-item">NGC</a>,
  
  <a href="/tags/#NVIDIA" class="tag-item">NVIDIA</a>
  
</div>
</p>
    <br/>
    <hr/>
  </header>

  <article class="post-content">
    <p><em>일전에 작성하였던 <a href="">nvidia-docker를 활용한 deep learning 환경 구축</a>이란 글이 있지만,
나의 사용방법도 변화하였고 nvidia-docker 2.0이 나왔기에 새로 작성하게 되었다. (이전 글은 내려놨다…)</em></p>

<h1 id="introduction">Introduction</h1>
<p>일단은 docker를 이용하는지에 대해선 이 글을 보시는 분들은 docker의 장점을 이미 알고 계실 것이라 생각하고 생각하려 한다. 아니면 docker를 쓰면 좋다는 이야기를 듣고 알아보고자 하시는 것이리라.</p>

<p>이 글은 간단한 Tutorial을 통해서 GPU가 구동되는 Deep Learning Framework을 구동하는 것이 이 글의 목표이다.
이후에 어떤 Customizing을 할 수 있는지는 별도의 글을 통해서 제공할 것이다. 다만 어떤 방향으로 이를 활용할 수 있는지는 글의 끝머리에 간단히 이야기해보려 한다.</p>

<p>여기서는 <em>nvidia-docker</em>와 <em>NGC</em>를 설명할 것인데, 이는 내가 생각하기에 바로 가져다 쓰는 용도로는 가장 최적의 조합이라고 생각하기 때문이다.
<a href="https://github.com/NVIDIA/nvidia-docker">nvidia-docker</a>는 docker container 내에서 NVIDIA GPU를 이용할 수 있도록 해주는 plug-in 또는 Wrapper이다. 따라서  즉, 독립적(standalone)으로 동작하지 못하므로, docker를 먼저 설치해야만 한다. <a href="https://ngc.nvidia.com/signin/email">NGC</a>는 NVIDIA에서 공개한 Docker registry로서 <a href="https://hub.docker.com/u/nvidia/">NVIDIA Dockerhub</a>을 통해 제공하던 것을 보다 전략적으로 배포하기 위해서 만든 서비스라고 볼 수 있다. NGC에 대해서는 별도의 글을 통해서 설명을 할 것이다.</p>

<h1 id="이용환경">이용환경</h1>

<p>원활한 실습을 위해 다음의 환경이 갖춰져 있어야 한다.</p>

<ol>
  <li>리눅스가 설치된 Desktop 또는 서버
    <ul>
      <li>Ubuntu나 CentOS 7이라면 문제 없음. Kernel이 3.X 대인 CentOS 6은 docker의 성능에 문제가 있다고 한다.
 여기서는 Ubuntu 환경을 기준으로 설명을 하겠지만, CentOS를 전에 이용했을때도 원활히 이용할 수 있었다.</li>
      <li>Windows에서는 docker가 VM위에서 동작하며, VM은 NVIDIA GPU를 지원하지 않으므로 제외</li>
      <li>MAC은 될지도 모르겠으나 내가 해볼 수 없으므로 이런 환경을 이용하시는 분은 자체적으로 해결하시거나 리눅스를 이용하시라고 말씀드려야 할 것 같다.</li>
    </ul>
  </li>
  <li>NVIDIA GPU
    <ul>
      <li>NVIDIA GPU가 있어야만 nvidia-docker를 설치할 수 있고, container에서 이용할 수 있다.</li>
      <li>GPU의 종류는 CUDA를 이용할 수 있는 모든 NVIDIA GPU라면 상관 없다. 다만 Jetson 이용자라면 아직 안해봐서 모르겠다.</li>
    </ul>
  </li>
</ol>

<h1 id="설치">설치</h1>

<p>완전히 새롭게 리눅스를 설치한 환경에서 다음의 절차 만으로 container 내에서 NVIDIA GPU를 이용할 수 있다.</p>

<ol>
  <li>NVIDIA Driver 설치</li>
</ol>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>add-apt-repository ppa:graphics-drivers/ppa
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get install nvidia-387
<span class="nb">sudo </span>reboot</code></pre></figure>

<ol>
  <li>Docker Install</li>
</ol>

<p>docker의 무료버전인 docker-ce를 설치한다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get install <span class="se">\</span>
    apt-transport-https <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    curl <span class="se">\</span>
    software-properties-common
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add -
<span class="nb">sudo </span>apt-key fingerprint 0EBFCD88
<span class="nb">sudo </span>add-apt-repository <span class="se">\</span>
   <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class="se">\</span><span class="s2">
   </span><span class="k">$(</span>lsb_release <span class="nt">-cs</span><span class="k">)</span><span class="s2"> </span><span class="se">\</span><span class="s2">
   stable"</span>
<span class="nb">sudo </span>apt-get update</code></pre></figure>

<p>Ubuntu 환경이 아닌 분들은 <a href="https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/#set-up-the-repository">docker 공식 설치 안내</a>을 참고해서 사용하는 배포판에 맞는 버전을 설치하면 된다.</p>

<p>다음 docker를 설치해주면 되는데, <strong>nvidia-docker를 이용할 것이라면 굳이 하지 않아도 된다</strong>. 이는 nvidia-docker에서 의존성을 확인하므로 알아서 설치를 해주기 때문이다. 그래도 설치를 하고 싶다면 아래와 같이 입력하면 된다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get install docker-ce</code></pre></figure>

<p>그리고 추가로 docker를 사용할 때 항상 <code class="highlighter-rouge">sudo</code>를 입력해야하는데, 이것이 번거로워서 매번 sudo를 입력하지 않아도 되도록 하기 위해서는 다음을 입력한다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span></code></pre></figure>

<ol>
  <li>nvidia-docker Install</li>
</ol>

<p>nvidia-docker의 버전이 2.0이 되면서 설치 방법에 변화가 생겼는데,
이전에는 deb이나 rpm 같은 패키지를 받아서 처리하는 방식이었다면 이제는 repository를 추가하여 처리하는 것으로 변경되었다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/nvidia-docker/gpgkey | <span class="se">\</span>
  <span class="nb">sudo </span>apt-key add -
curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/nvidia-docker/ubuntu16.04/amd64/nvidia-docker.list | <span class="se">\</span>
  <span class="nb">sudo </span>tee /etc/apt/sources.list.d/nvidia-docker.list
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get install <span class="nt">-y</span> nvidia-docker2
<span class="nb">sudo </span>pkill <span class="nt">-SIGHUP</span> dockerd</code></pre></figure>

<p>여기서도 역시 다른 배포판을 이용한다면 <a href="https://nvidia.github.io/nvidia-docker/">nvidia-docker 설치 안내문서</a>를 참고하면 된다. 기존 nvidia-docker는 패키지를 제공하는 방식이었는데, 저장소를 이용하게 되면서 얻는 장점으로는 이전에는 docker가 update되는 과정에서 nvidia-docker가 지원하지 않으면서 조금전만 해도 되던 docker가 안되는 상황을 방지할 수 있게 되었다는 것이다.</p>

<p>한편 주의할 점은 만약 이전에 nvidia-docker를 이용하고 있었다면, 사전에 삭제를 먼저 해야만 한다.</p>

<p><strong>Ubuntu distributions</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker volume <span class="nb">ls</span> <span class="nt">-q</span> <span class="nt">-f</span> <span class="nv">driver</span><span class="o">=</span>nvidia-docker | xargs <span class="nt">-r</span> <span class="nt">-I</span><span class="o">{}</span> <span class="nt">-n1</span> docker ps <span class="nt">-q</span> <span class="nt">-a</span> <span class="nt">-f</span> <span class="nv">volume</span><span class="o">={}</span> | xargs <span class="nt">-r</span> docker rm <span class="nt">-f</span>
<span class="nb">sudo </span>apt-get purge nvidia-docker</code></pre></figure>

<p><strong>CentOS distributions</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker volume <span class="nb">ls</span> <span class="nt">-q</span> <span class="nt">-f</span> <span class="nv">driver</span><span class="o">=</span>nvidia-docker | xargs <span class="nt">-r</span> <span class="nt">-I</span><span class="o">{}</span> <span class="nt">-n1</span> docker ps <span class="nt">-q</span> <span class="nt">-a</span> <span class="nt">-f</span> <span class="nv">volume</span><span class="o">={}</span> | xargs <span class="nt">-r</span> docker rm <span class="nt">-f</span>
<span class="nb">sudo </span>yum remove nvidia-docker</code></pre></figure>

<h1 id="docker-동작-확인">docker 동작 확인</h1>

<p>이제 모든 준비가 되었다. 다음의 명령으로 Container에서 nvidia-gpu가 정상적으로 인식이 되는지 확인할 수 있다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker pull nvidia/cuda
docker run <span class="nt">--runtime</span><span class="o">=</span>nvidia <span class="nt">--rm</span> <span class="nt">-ti</span> nvidia/cuda nvidia-smi</code></pre></figure>

<p><img class="col two center" src="/images/201712/docker-nvidia-smi.png" /></p>

<p>한편 이전의 명령도 함께 지원해준다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nvidia-docker run <span class="nt">--rm</span> <span class="nt">-ti</span> nvidia/cuda nvidia-smi</code></pre></figure>

<p><img class="col two center" src="/images/201712/nvidia-docker-smi.png" /></p>

<p>무엇이 편할지는 각자가 판단할 부분이라고 생각한다. docker를 쓰다보면 각종 파라미터 입력이 귀찮아서 shell을 만들기도 하는데, 어떤것이 편할지는 역시 각자가 판단할 부분이다.</p>

<h1 id="gpu-나눠-쓰기">GPU 나눠 쓰기</h1>
<p>nvidia-docker는 한가지 더 유용한 기능을 갖고 있는데 다음과 같이 입력하면 GPU를 나눠 쓸 수 있다. GPU가 4개가 있는 시스템을 예로 들어보겠다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nvidia-docker run <span class="nt">--rm</span> <span class="nt">-ti</span> nvidia/cuda nvidia-smi</code></pre></figure>

<p><img class="col two center" src="/images/201712/nvidia-docker-4gpu.png" /></p>

<p>이는 과거 명령인 <code class="highlighter-rouge">nvidia-docker</code>에서도 동일하게 동작한다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">NV_GPU</span><span class="o">=</span>0,1 nvidia-docker run <span class="nt">--rm</span> <span class="nt">-ti</span> nvidia/cuda nvidia-smi</code></pre></figure>

<p><img class="col two center" src="/images/201712/nvidia-docker-2gpu.png" /></p>

<h1 id="nvidia-gpu-cloud">NVIDIA GPU CLOUD</h1>
<p>2017년 10월 26일, NVIDIA는 NGC라는 것을 발표한다. 그 그림은 여러 사람을 혼란에 빠지게 했었는데, 마치 NVIDIA가 AWS나 GCP와 같이 Cloud 사업에 진출하는 것처럼 보였기 때문이다.
<img class="col two center" src="/images/201712/NVIDIA GPU Cloud for Deep Learning, HPC Applications and HPC Visualization.png" />
하지만 그것이 아니고 registry로서, nvidia에서 제공한 container를 기반으로 개발하고, cloud를 통해서 배포하라는 의미로 이름을 그렇게 지은 것이라고 한다.</p>

<p>NGC를 이용하는 방법은 <em>NGC에 가입 및 활용하는 방법 (작성중)</em>을 확인해서 사용하면 된다. NGC는 https://ngc.nvidia.com 에서 가입 및 계정을 이용할 수 있으며, 웹페이지에도 설명이 있으므로 참고해서 이용할 수 있다. 웹페이지에 접속하면 다음과 같은 창이 나온다.
<img class="col two center" src="/images/201712/ngc-intro.png" /></p>

<p>이를 docker에서 다음과 같이 가져올 수 있다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker pull nvcr.io/nvidia/tensorflow:17.12
docker pull nvcr.io/nvidia/caffe:17.12</code></pre></figure>

<p>즉, framework 별로 이름이 달리 되어 관리되고 있고, 버전은 tag 항목에서 17.12와 같이 “년도.월”로 관리가 된다. 만일, TF같이 한달이 멀다하고 버전이 올라가는 Framework에서는 다음과 같이 container에게 물어보고 버전을 알 수 있다.</p>

<p><img class="col center" src="/images/201712/ngc-tf-version.png" /></p>

<p>이 Container에는 NVIDIA에서 준비한 예제 코드들이 들어가져 있어서 바로 시험을 해볼 수 있다. ()테스트 조건은 Resnet50 이용, Batch Size는 64, GPU는 4개 사용)</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nvidia-docker run <span class="nt">--rm</span> <span class="nt">-ti</span> nvcr.io/nvidia/tensorflow:17.12 ./nvidia-examples/cnn/nvcnn.py <span class="nt">-m</span> resnet50 <span class="nt">-b</span> 64 <span class="nt">-g</span> 4</code></pre></figure>

<p>그러면 아래와 같은 화면이 나온다.
<img class="col two center" src="/images/201712/tf-test-start.png" /></p>
<p class="center">중략</p>
<p><img class="col two center" src="/images/201712/tf-test-end.png" /></p>

<p>그러면 Tesla P100 GPU 4장을 사용한 환경에서 synthetic image를 활용하여 초당 820장 정도의 학습이 된다는 것을 알 수 있게 된다. tfrecord를 만들어 활용하더라도 model이 GPU에서 소비하는 데이터 량이 Disk I/O보다 떨어지므로 그리 큰 영향을 미치지는 않는다.
이제 각자 시험해보고 싶은 모델과 데이터를 갖고 시험을 해볼 수 있는 환경이 구성이 되었다.</p>

<p><br /></p>

  </article>

  <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;&quot;%20http://localhost:4000/docker/2017/12/01/nvidia-docker-ngc.html%20via%20&#64;haanjack&hashtags=docker,nvidia-docker,NGC,NVIDIA,"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook"href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/docker/2017/12/01/nvidia-docker-ngc.html"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
    <a aria-label="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:4000/docker/2017/12/01/nvidia-docker-ngc.html"
    onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">
        <svg class="icon icon-google-plus"><use xlink:href="#icon-google-plus"></use></svg>
    </a>
</section>
  <section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'haanjack';
        var disqus_title = '';
        var disqus_url = '/docker/2017/12/01/nvidia-docker-ngc.html';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
  	<p>Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and is hosted on <a href="https://github.com" target="_blank">Github</a>.  Theme from <a href="https://github.com/bogoli/-folio" target="_blank">folio</a> by Lia Bogoev, MIT Licence. &#169; 2016.</p>
  </div>

</footer>


  </body>

</html>
