---
layout: post
title: 성능 모델(Performance Model)
date: 2023-01-03 16:40:16
description: 병렬처리 하드웨어의 성능을 예측하는 모델에 대한 이해와 성능 분석
tags:
  - cuda
categories: cuda programming, parallel programming, performance
taxonomy: cuda
lang: ko
published: false
permalink: /ko/cuda-programming/performance-model
translation: /en/cuda-programming/performance-model
---

# Performance Model

우리가 어떤 CPU나 GPU의 성능을 비교한다고 했을때 보통 제조사에서 밝힌 스펙(spec)을 이야기합니다.
이러한 스펙은 한때엔 CPU의 클럭 속도였다가, 코어의 개수였는데, GPU가 주목받는 요즘은 플로팅 포인트 연산량(FLOPS)이라는 것이 주로 사용되고 있습니다.
그런데 이 스펙은 어떻게 정의되고 측정되는 것일까요? 그리고 이 스펙을 어떻게 해석해야 할까요? 이번 장에서는 이러한 성능 모델에 대해 알아보도록 하겠습니다.

## Rmax와 Rpeak

슈퍼컴퓨터의 성능을 측정하는 리더보드인 TOP500에서는 Rmax와 Rpeak라는 두 가지 지표를 사용합니다[^1]. Rmax는 실제로 실행되는 애플리케이션의 성능을 측정하는 지표이며, Rpeak는 해당 컴퓨터가 이론적으로 가능한 최대 성능을 측정하는 지표입니다.

Rmax는 실제 애플리케이션의 성능을 측정하기 때문에, 애플리케이션의 특성에 따라 성능이 다를 수 있습니다. 다양한 애플리케이션을 실행하고 그 성능을 측정하여 슈퍼컴퓨터의 실제 성능을 평가합니다.

반면에 Rpeak는 이론적으로 슈퍼컴퓨터가 가능한 최대 성능을 측정하는 것입니다. 이 지표는 슈퍼컴퓨터의 하드웨어 스펙을 보여주는데, 클럭 주파수, 프로세서 개수, 코어 개수 등과 같은 하드웨어의 특성을 반영합니다. 애플리케이션의 특성에 따라 성능이 달라지지 않으며, 이론적인 최대 성능을 제공합니다.

따라서, TOP500에서 Rmax는 실제 애플리케이션 실행을 통해 측정되는 성능을 나타내며, Rpeak는 슈퍼컴퓨터의 하드웨어 스펙과 이론적인 최대 성능을 보여주는 지표로 사용됩니다.


### Rpeak
Rpeak는 이 컴퓨터가 가능한 최대 성능을 측정하는 지표입니다. 이론적으로, 이 컴퓨터의 최대 성능은 다음과 같이 계산됩니다.

$$
R_{peak} = \frac{1}{T} \times \sum_{i=1}^{N} F_i \times P_i \times C_i
$$

여기서 $T$는 클럭 주파수이며, $F_i$는 클럭 주파수 비율, $P_i$는 프로세서의 개수, 그리고 $C_i$는 코어의 개수를 나타냅니다.
이론적으로, 이 컴퓨터의 최대 성능은 클럭 주파수, 프로세서 개수, 코어 개수의 조합으로 결정됩니다.
또한, 이론적으로 이 컴퓨터의 최대 성능은 하드웨어 스펙에 의해 결정되므로 애플리케이션의 특성에 따라 성능이 변하지 않습니다.

예를 들어, 이 컴퓨터의 클럭 주파수가 2GHz이고, 프로세서의 개수가 2개, 코어의 개수가 4개라고 가정해봅시다. 이 컴퓨터의 최대 성능은 다음과 같이 계산됩니다.

$$
R_{peak} = \frac{1}{2GHz} \times 2 \times 4 = 4 GFLOPS
$$

이론적으로, 이 컴퓨터의 최대 성능은 4 GFLOPS입니다. 그런데, 이론적으로 이 컴퓨터의 최대 성능은 4 GFLOPS이지만, 실제로 이 컴퓨터에서 실행되는 애플리케이션의 성능은 4 GFLOPS가 아닐 수 있습니다. 왜냐하면 어플리케이션의 동작에 영향을 미치는 다양한 요소들 (I/O 지연시간, 메모리 대역폭, 캐시의 크기 등)이 있기 때문입니다. 이것은 이론적인 최대 성능과 실제 애플리케이션의 성능이 다를 수 밖에 없다는 것을 의미합니다.
한편으로는 이 수치는 참고만 해야할 뿐 절대적으로 여러분의 벤치마크 어플리케이션에러 볼 수 없는 숫자라는 것을 의미하기도 합니다.

### Rmax
Rmax는 이 컴퓨터에서 실행되는 애플리케이션의 성능을 측정하는 지표입니다. 이 컴퓨터에서 실행되는 애플리케이션의 성능은 다음과 같이 계산됩니다.

$$
R_{max} = \frac{1}{T} \times \sum_{i=1}^{N} F_i \times P_i \times C_i \times E_i
$$

여기서 $E_i$ 는 애플리케이션의 특성에 따른 비율을 나타냅니다. 이 비율은 애플리케이션의 특성에 따라 다릅니다.
따라서, 이 컴퓨터에서 실행되는 애플리케이션의 성능은 클럭 주파수, 프로세서 개수, 코어 개수를 곱한 값에 애플리케이션의 특성에 따른 비율을 곱한 값입니다.
그러나, 애플리케이션의 특성에 따른 비율이라는 것은 애플리케이션마다 다르기도 하거니와, 이것을 이론적으로 계산하기가 어렵습니다. 따라서, 이 비율은 실제 애플리케이션을 실행하여 측정합니

Top500에서는 Linpack이라는 애플리케이션을 사용하여 Rmax를 측정합니다. Linpack은 선형대수학의 연산을 수행하는 애플리케이션으로, 행렬의 곱셈과 역행렬을 구하는 연산을 수행합니다. 이것은 슈퍼컴퓨터의 분산처리 능력을 최대한 활용하여 행렬의 곱셈과 역행렬을 구하는 애플리케이션입니다. 비록 이것이 모든 어플리케이션의 성능을 대변한다고는 할 수 없겠지만, 이것은 슈퍼컴퓨터의 성능을 측정하는데에 있어서 가장 효율적인 방법이라고 할 수 있습니다.


## Amdahl's Law

Amdahl's Law는 병렬화가 가능한 애플리케이션의 성능을 측정하는 지표입니다. 이 지표는 애플리케이션의 병렬화 비율을 나타내며, 병렬화가 가능한 애플리케이션의 성능을 측정하는데에 사용됩니다. 컴퓨터 공학 전공이라면 다들 한번쯤을 들었을 만큼 중요한 내용이기도 합니다.

Amdahl's Law는 다음과 같이 정의됩니다.

$$
S = \frac{1}{(1-P) + \frac{P}{N}}
$$

여기서 $S$는 애플리케이션의 성능을 나타내며, $P$는 애플리케이션의 병렬화 비율을 나타냅니다. $N$은 프로세서의 개수를 나타냅니다.
즉, 전체 애플리케이션의 성능은 병렬화 비율과 프로세서의 개수에 의해 결정됩니다. 병렬화 비율이 높을수록, 프로세서의 개수가 많을수록 애플리케이션의 성능은 높아집니다. Amdahl's law는 또 한가지 중요한 시사점을 갖고 있는데요, 병렬화 비율이 높다고 해서 애플리케이션의 성능이 선형적으로 증가하는 것은 아니라는 것입니다. 즉, 병렬성에 의하여 애플리케이션의 성능을 높이는 것이 증가하는 난이도에 비해 얻는 것이 적다는 것을 의미합니다. 이것은 애플리케이션의 병렬화를 통해 얻을 수 있는 성능 향상의 한계를 보여줍니다.


## Roofline Model

Roofline Model은 메모리 대역폭과 연산량, 그리고 알고리즘의 복잡도 등을 고려하여 애플리케이션의 성능을 예측하는 모델입니다. 이전까지의 성능 모델은 하드웨어의 연산 능력만을 따졌다면 이 모델은 메모리와 연산 능력을 모두 고려합니다. 이 모델은 각각의 능력치를 하드웨어 성능의 한계치로 설정하고, 어플리케이션의 알고리즘 복잡도에 따라 보다 나은 알고리즘을 선택하거나 최적화의 우선순의를 정하는데 사용됩니다.

$$
R = min \left( \frac{F}{T}, \frac{B}{T} \right)
$$

여기서 $R$은 애플리케이션의 성능을 나타내며 보통 Flops로 표현됩니다. $F$는 연산량, $B$는 메모리 대역폭, $T$는 애플리케이션의 복잡도를 나타냅니다. 여기서 알고리즘 복잡도는 우리가 흔히 알고 있는 Big-O notation과는 다른 Arithmetic Intensity를 의미하는데, byte당 Flops를 표현합니다. 다시말해서 특정 하드웨어에서 ($F$와 $B$ 고정) 각기 다른 알고리즘별로 가용한 성능을 비교할 수 있도록 해줍니다.

이 모델은 다음과 같이 그려집니다.

![roofline](/assets/images/roofline.png)

이 모델은 각기 다른 하드웨어간의 성능차이를 비교하는데 사용되어질 수도 있고,

![roofline2](/assets/images/roofline2.png)

동일한 하드웨어에서 Arithmetic Intensity가 각기 다른 알고리즘의 최적화 정도를 평가하거나 더 나은 알고리즘을 선택하는데 사용될 수도 있습니다.

![roofline3](/assets/images/roofline3.png)


## 맺으며

결국은 하드웨어의 성능은 어떤 한가지의 지표로 결정되어지기 않으며, 이 하드웨어를 기반하여 동작하는 애플리케이션의 특성에 따라 결정된다고 할 수 있습니다. 다시 말해서, 이론상 스펙인 Rpeak가 가장 우수한 하드웨어를 활용한다고 하더라도, 이 하드웨어의 성능을 최대한 끌어낼 수 있는 애플리케이션을 사용하지 않는다면 최종적으로 얻는 성능은 그리 좋지 않을 것입니다. 따라서 하드웨어의 성능을 최대한 활용하기 위해서는 하드웨어의 특성을 잘 이해하고, 이에 맞게 최적화된 애플리케이션을 사용했을때 최적의 능을 얻을 수 있습니다.


### 참고자료

[^1]: https://www.top500.org/project/top500_description/
