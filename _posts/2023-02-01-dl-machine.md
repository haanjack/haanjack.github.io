---
layout: post
title:  "딥러닝용 데스크탑 구축기"
description: "LLM 시대를 맞이하여 딥러닝 실습을 위한 데스크탑 만들어보기"
date:   2023-02-14
published: false
categories: mlsys
tags:
 - mlsys
 - AVX-512
 - deepspeed
 - transformers
 - llm
 - CUDA
---

# 딥러닝 데스크탑 제작기

2023년을 맞이하면서 10년 남짓 사용한 데스크탑을 교체했다. 사실 교체를 하기로 마음을 먹은지 1년 정도 기다렸다가 구성을 한 것이다. 다행히도 나는 회사에서 많은 장비를 지원받고 있기는 하지만, 개인적으로 공부해보고 시험을 해볼 장비가 필요하다고 느꼈고 그래서 투자를 한다는 생각으로 적지 않은 돈이었지만 새로이 시스템을 만들었다.


# 새로운 시스템으로 하고자 하는 것

우선 새로운 데스트탑이 생기게 된다면 어떤 것을 하려고 하는지 정리를 해보았다.

- CUDA를 비롯한 병렬처리 언어의 공부 및 복습
- MLOps/LLMOps 도구들에 대한 공부
- 여러 논문들의 간단한 구현들 또는 시험
- 개인 공부와 회사 자산과의 분리
  - 이 부분이 가장 민감한 부분인데 회사 자산(노트북, 서버, GPU등)을 쓰면, 그것이 외부로 부터 얻은 지식이고 회사의 사업 내용을 직접적으로 다룬다고 하지 않더라도 문제가 있다고 생각한다.


# 대안에 대한 검토

사실 데스크탑을 굳이 구축해야하는지도 생각해야하는 부분이었다. 자원의 투자는 결국 비용을 의미하고 내가 애써 벌어들인 돈을 내보내는 것이기 때문이다.
다만 내가 아는 범위에서 정리를 한 것이지 정교하게 비교를 했던 것은 아니다. ~~어쩌면 구매를 정당화하기 위한 비교였을지도 모르지~~

비교해볼 수 있는 대상은 바로 클라우드였던 것 같다. 개인으로서 클라우드의 장점은 명확했다.

1. 필요할때에만 돈을 지불하는 식으로 비용을 아낄 수 있다.
  - 특히, 일주일에 위 목적에 몇시간 할애하지도 못할테니 한달에 10만원으로 예산을 설정해도 그게 더 저렴할 것이다.
2. 클라우드에서 제공하는 다양한 도구를 살펴볼 기회가 생긴다.
3. MultiGPU가 필요해지면 그때 또 확장해서 쓰면 된다.

반면 데스크탑을 구성할 경우 장점은 이랬다.

1. 손에 익은 환경으로 계속해서 쓸 수 있다.
  - 하루정도 학습을 해보는 시도는 해볼 수 있지 않을까
  - 클라우드라고 해도 내가 원하는대로 구성이 되어 있게 하려면 비싸다.
2. Colab Compute unit도 이제는 저렴하지 않더라.
  - 찾아보니 GPU 클라우드 회사가 여럿 있긴 하던데, 이 부분은 나중에 별도로 조사를 해봐야 할 것 같다.
3. 데이터셋을 그냥 복사해두고 필요할때 꺼내쓸 수 있다.
  - 이건 약간의 게으름을 위한 것이다.

아무튼 대충 계산기를 두들겨 봤을때, 이것으로 열심히 모델을 학습해야만 하는 상황이 되지만 않는다면,
이번에 구성하는 것으로 10년은 쓴다고 생각해야하고 열심히 쓰지 않는다면 클라우드가 이익이기는 했다.
물론 그렇게 열심히 쓴다면 전기료도 무시하지 못하긴 할 것이다. 그렇게 해서 배운게 그만한 의미가 있어야 할텐데...


# 시스템 구성 내역

아무튼 나는 다음과 같이 시스템을 구성하였다. 각각에 대해 이유가 있는데, 이에 대해서는 별도로 설명을 이어갈 것이다.

| device | 사양 |
| CPU | AMD Ryzen 9 7900 Non-X |
| RAM | Cosair Vengeance 32GB DDR5 5200Mhz x4 |
| Motherboard | ASUS x670e-creator WIFI |
| GPU | NVIDIA RTX 3090 FE 24GB |
| SSD | WD 850x 2TB |

## CPU

내가 구매를 하던 당시에는 Intel과 AMD 양쪽에서 모두 새로운 CPU를 출시했으며, Intel의 13세대의 성능이 AMD CPU를 앞서서 여러 면에서 추천이 되던 시기였다. 사실 나에게 CPU란 GPU를 구동시키기 것과 약간의 컴파일 정도가 더 중요했기 때문에 벤치마크는 별 의미는 없다고 생각한다.

다만 성능과 관련하여 아래 몇가지 따져보았다.
1. 전력 소모량
  - INTEL CPU의 전력소모량이 AMD CPU와 비교하여 상대적으로 너무 많이 전기를 먹는다는 생각이 들었다. 더욱이 인터넷 상에 보이는 후기를 보면 공랭 대장급이나 수냉을 써야만 한다는 글들이 많이 보였다. 나는 CPU를 GPU를 구동시키기위해서만 쓸 것인데 전력을 너무 많이 사용하는 것으로 보였다.
2. P,E 코어
  - 사실 난 이 기술에 별로 신경을 쓰고 싶지 않았다. 나에게는 P,E 코어 전략이 저전력을 위한 부분이라기 보다는 최대 성능을 높이기 위한 전략으로 읽혔다. 그런데 그 좋은 기술이 앞으로 나올 Sapphire Rapids에도 포함이 되어 있지 않았다.
3. AVX-512
  - Ryzen 5세대에서는 흥미롭게도 서버에서나 볼 수 있는 AVX-512가 포함되었다. 이것을 가져다가 CPU에서 optimizer를 이용할 수 있을 것이라는 생각이 들었다. 특히 DeepSpeed 문서에서 보면 CPU Adam Optimizer에서 AVX-2를 사용한 것과 비교하여 5.1배에서 6.5배까지 속도가 빨라졌다고 하한다. (https://www.deepspeed.ai/training/#cpu-adam-high-performance-vectorized-implementation-of-adam)

그래서 나는 AMD CPU를 선택했다. 또한 CPU가 optimizer를 계산하게 할 수 있게 할 수 있다는 점을 고려하여 코어수를 높이는 것이 좋을 것이라고 생각했다. 그래서 Ryzen 5세대에서 코어가 많은 7900을 선택했다. 그리고 Non-X를 선택한 것은 지극히 주관적으로 난 수냉을 하고 싶지 않았고, 필요하다면 overclock 장인들이 남긴 글을 참고해서 할 수 있지 않을까 생각했기 때문이다.

## MotherBoard

MotherBoard는 ASUS ProArt X670e를 선택했다. 이것을 선택한 이유는 다음과 같다.
1. PCIe Gen5 지원
2. DDR5 지원
3. 128GB RAM 지원
4. Multi-GPU를 해야하는 경우에 대비할 수 있을 것
  - 그리고 그 경우에 PCIe 레인수를 균일하게 (x8/x8)로 나눠줄 수 있을 것

사실 구매하던 당시에 AMD의 메인보드가 인텔과 비교해서 비싸다는 평을 많이 듣고 있었다. 실제로 저 조건을 1-3까지 모아두면 그러했다. 생각해보면 AMD는 오랜시간 지원을 하도록 만들 예정이니 제조사 입장에서는 비싸게 팔려고 하지 않을까 싶다.
그런데 4번 조건이 붙고 나면, Intel은 가장 저렴한 보드가 100만원이 넘었지만 AMD는 그렇지 않았다. 특히 내가 선택한 보드는 그중에서도 가장 저렴했다. Lane 을 균일하게 나누는 것이 가장 어려운 조건이었는데, 대부분의 보드가 그러하지 않았기에 제조사에서 제공하는 설명서를 하나씩 확인하면서 스펙을 확인해야 했다. 또한 이 스펙은 장기적으로 중요한 부분인데, 장기적으로 DDR5를 지원하는 그래픽카드가 출시되었을때 NVLINK는 없게 될 것으로 예상이 되었다. (https://www.techpowerup.com/299107/jensen-confirms-nvlink-support-in-ada-lovelace-is-gone)
나 스스로도 고작 두장의 GPU에서 NVLINK의 효익이 크지는 않은 것 같고, NVIDIA 입장에서는 NVLINK 브릿지를 실제로 구메하는 사람이 많을지도 의문이 든다.

## GPU

이건 구매없이 현재 내가 가지고 있는 RTX 3090을 그대로 이용하기로 했다. RTX 4090을 넘어갈 수
